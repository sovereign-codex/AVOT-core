name: Convergence Reasoning Test

on:
  workflow_dispatch:
  push:
    paths:
      - "convergence/**"
      - ".github/workflows/convergence.yml"
      - "clients/**"
      - "core/**"

jobs:
  converge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install AVOT-Core dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade openai
          pip install -r requirements.txt || true

      - name: Preload Guardian + Registry
        run: |
          python << 'EOF2'
          from core.registry import load_registry
          from core.guardian import guardian_eval
          print("ðŸ“˜ Loading AVOT Registry...")
          reg = load_registry()
          print("ðŸ“˜ Agents discovered:", list(reg.keys()))

          print("ðŸ›¡ï¸ Performing Guardian Pre-Eval...")
          try:
              out = guardian_eval({"test": "ping"})
              print("ðŸ›¡ï¸ Guardian response:", out)
          except Exception as e:
              print("âš ï¸ Guardian pre-eval failed:", e)
          EOF2

      - name: Run Convergence Engine
        run: |
          python << 'EOF3'
          from convergence.engine import converge

          print("ðŸ”® Starting Convergence Reasoning Engineâ€¦")
          try:
              result = converge()
              print("ðŸ§  Convergence Output:", result)
          except Exception as e:
              print("âŒ Convergence Engine Error:", e)
              raise
          EOF3

      - name: Save Convergence Report
        if: success()
        run: |
          echo "Convergence executed successfully." > convergence_report.txt

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: convergence-report
          path: convergence_report.txt
